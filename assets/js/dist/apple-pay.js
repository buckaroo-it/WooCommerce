(()=>{"use strict";const t=(t,e)=>{var a;return function(){var i=this,o=arguments;clearTimeout(a),e&&!a&&t.apply(i,o),a=setTimeout((()=>{a=null,e||t.apply(i,o)}),250)}},e=t=>Math.round(100*t)/100;class a{constructor(){this.api_namespace="WC_Gateway_Buckaroo_applepay",this.url=buckaroo_global.ajax_url,void 0===this.url&&(this.url="/")}getItems(t){if(jQuery(".applepay-button-container").hasClass("is-detail-page")){const i=this.getCurrentShownProduct(),o={"wc-api":`${this.api_namespace}-get-items-from-detail-page`,product_id:i.product_id,variation_id:i.variation_id,quantity:jQuery(".cart .quantity input").val()||1,country_code:t};var a=[];return jQuery.ajax({url:this.url,data:o,async:!1,dataType:"json"}).done((t=>{a=t.map((t=>({id:t.id,name:t.name,price:e(t.price),quantity:t.quantity,type:t.type,attributes:t.attributes})))})),a}var i=[];return jQuery.ajax({url:this.url,data:{"wc-api":`${this.api_namespace}-get-items-from-cart`},async:!1,dataType:"json"}).done((t=>{i=t.map((t=>({id:t.id,name:t.name,price:e(t.price),quantity:t.quantity,type:t.type,attributes:t.attributes})))})),i}getShippingMethods(t){const e=(()=>{if(jQuery(".applepay-button-container").hasClass("is-detail-page")){const t=this.getCurrentShownProduct();return{product_id:t.product_id,variation_id:t.variation_id,quantity:jQuery(".cart .quantity input").val()||1}}return{}})(),a={"wc-api":`${this.api_namespace}-get-shipping-methods`,country_code:t};var i;return jQuery.ajax({url:this.url,data:Object.assign(a,e),dataType:"json",async:!1}).done((t=>{i=t})),i}getStoreInformation(){var t=[];return jQuery.ajax({url:this.url,data:{"wc-api":`${this.api_namespace}-get-shop-information`},async:!1,dataType:"json"}).done((e=>{t=e})),t}getCurrentShownProduct(){const t=jQuery('[name="add-to-cart"]').val();return{product_id:t,variation_id:jQuery('[name="variation_id"]')[0]&&0!=jQuery('[name="variation_id"]').val()&&""!=jQuery('[name="variation_id"]')[0]?jQuery('[name="variation_id"]').val():t}}displayErrorMessage(t){const e=`      \n      <div class="woocommerce-message" role="alert">\n        ${t}\n      </div>\n    `;jQuery(".woocommerce-notices-wrapper").first().prepend(e),jQuery("html, body").scrollTop(0)}canOrderAmount(){if(jQuery(".checkout.woocommerce-checkout").length)return!0;const t=parseInt(jQuery(".cart .quantity input.qty").val()),e=parseInt(jQuery(".cart .quantity input.qty").attr("max"));return isNaN(e)?t>0:t>0&&t<=e}}class i{constructor(){this.woocommerce=new a}createTransaction(t,e,a,i){jQuery.ajax({url:"/?wc-api=WC_Gateway_Buckaroo_applepay-create-transaction",method:"post",data:{selected_shipping_method:a,paymentData:t,amount:e,items:i},dataType:"json",async:!1}).done((t=>{"success"==t.result?window.location.replace(t.redirect):this.woocommerce.displayErrorMessage(t.message)})).fail((()=>{this.woocommerce.displayErrorMessage("Something went wrong while processing your payment.")}))}}class o{constructor(){this.buckaroo=new i,this.woocommerce=new a,this.store_info=this.woocommerce.getStoreInformation(),this.selected_shipping_method=null,this.selected_shipping_amount=null,this.total_price=null,this.country_code=this.store_info.country_code}rebuild(){jQuery(".applepay-button-container div").remove(),jQuery(".applepay-button-container").append("<div>")}init(){BuckarooSdk.ApplePay.checkApplePaySupport(this.store_info.merchant_id).then((t=>{if(t){const t=this.getItems(),e=this.woocommerce.getShippingMethods(this.country_code),a=this.getFirstShippingItem(e),i=null!==a?[].concat(t,a):t,o=this.sumTotalAmount(i),n={label:"Totaal",amount:o,type:"final"};e.length>0&&(this.selected_shipping_method=e[0].identifier,this.selected_shipping_amount=e[0].amount),this.total_price=o;const r=["name","email","postalAddress","phone"],s=new BuckarooSdk.ApplePay.ApplePayOptions(this.store_info.store_name,this.store_info.country_code,this.store_info.currency_code,this.store_info.culture_code,this.store_info.merchant_id,i,n,"shipping",e,this.processApplepayCallback.bind(this),this.processShippingMethodsCallback.bind(this),this.processChangeContactInfoCallback.bind(this),r,r);new BuckarooSdk.ApplePay.ApplePayPayment(".applepay-button-container div",s).showPayButton("black")}}))}processChangeContactInfoCallback(t){this.country_code=t.countryCode;const e=this.getItems(),a=this.woocommerce.getShippingMethods(this.country_code),i=this.getFirstShippingItem(a),o=null!==i?[].concat(e,i):e,n=this.sumTotalAmount(o),r={newShippingMethods:a,newTotal:{label:"Totaal",amount:n,type:"final"},newLineItems:o};if(a.length>0){var s={};this.selected_shipping_method=a[0].identifier,this.selected_shipping_amount=a[0].amount}else s=this.shippingCountryError(t);return this.total_price=n,Promise.resolve(Object.assign(r,s))}processShippingMethodsCallback(t){const a=this.getItems(),i={type:"final",label:t.label,amount:e(t.amount)||0,qty:1},o=[].concat(a,i),n=this.sumTotalAmount(o),r={label:"Totaal",amount:n,type:"final"};return this.selected_shipping_method=t.identifier,this.selected_shipping_amount=t.amount,this.total_price=n,Promise.resolve({status:ApplePaySession.STATUS_SUCCESS,newTotal:r,newLineItems:o})}processApplepayCallback(t){const e={status:ApplePaySession.STATUS_SUCCESS,errors:[]};if(e.status===ApplePaySession.STATUS_SUCCESS)this.buckaroo.createTransaction(t,this.total_price,this.selected_shipping_method,this.woocommerce.getItems(this.country_code));else{const t=e.errors.map((t=>t.message)).join(" ");this.woocommerce.displayErrorMessage(`Your payment could not be processed. ${t}`)}return Promise.resolve(e)}sumTotalAmount(t){const a=t.reduce(((t,e)=>t+e.amount),0);return e(a)}getFirstShippingItem(t){return t.length>0?{type:"final",label:t[0].label,amount:t[0].amount||0,qty:1}:null}getItems(){return this.woocommerce.getItems(this.country_code).map((t=>{return{type:"final",label:(a=`${t.quantity} x ${t.name}`,25,a.length>25?`${a.slice(0,25)}...`:a),amount:e(t.price),qty:t.quantity};var a}))}shippingCountryError(t){return{errors:[new ApplePayError("shippingContactInvalid","country","Shipping is not available for the selected country")]}}}jQuery((function(){if(jQuery(".applepay-button-container")[0]){const e=new o,i=new a,n=t((()=>{e.rebuild(),i.canOrderAmount()&&e.init()}));0===jQuery(".variations_form").length&&(n(),jQuery(".cart .quantity input").change((()=>{n()}))),jQuery(".variations_form").on("show_variation",(()=>{n(),jQuery(".cart .quantity input").change((()=>{n()}))})),jQuery(".variations_form").on("hide_variation",(()=>{e.rebuild()})),jQuery(document.body).on("wc_fragments_refreshed",(()=>{n()})),jQuery(document.body).on("updated_shipping_method",(()=>{e.rebuild(),e.init()}))}}))})();